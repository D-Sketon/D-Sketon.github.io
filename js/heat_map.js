var MONTH_NAMES=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],pluralize=(e,t)=>e+" "+t+(e<=1?"":"s");function getTooltip(e,t){return t=new Date(t.getTime()-6e4*t.getTimezoneOffset()).toISOString().split("T")[0],e.count===0?"No writing on "+t:`${pluralize(e.post,"post")} ${pluralize(e.count,"word")} on `+t}var heatmapTooltip=document.getElementById("heatmap-tooltip");function hideTooltip(){heatmapTooltip.style.display="none"}function tileClickHandler(e){let t=e.target;if(t.classList.contains("tile")){let r=new Date(Number(t.dataset.date)),s=r.toISOString(),o=window.REIMU_HEATMAP_CONFIG.articleStats.filter(c=>c.date===s),i=t.dataset.level,m=r.toLocaleDateString(),n=0,l=`
    <div class="tooltip-header">
      <div class="tooltip-header-content">${m} (Level ${i})</div>
      <div class="popup-btn-close tooltip-close"></div>
    </div>
    <div class="tooltip-content">
      <ul>
  `,d=window.REIMU_HEATMAP_CONFIG.i18n,p=document.documentElement.lang||"en";Object.keys(d).includes(p)||(p="en"),o.length===0?l+=`<li>${d[p].no_articles}</li>`:o.forEach(c=>{n+=c.wordcount,l+=`<li><a href="${c.url}">${c.title}</a> (${c.wordcount} ${d[p].words})</li>`});var e=d[p].total_articles.replace("$1",o.length).replace("$2",n),e=(l+=`
      </ul>
      <div class="tooltip-footer">
        ${e}
      </div>
    </div>
  `,heatmapTooltip.innerHTML=l,t.getBoundingClientRect()),a=(heatmapTooltip.style.display="block",heatmapTooltip.style.visibility="hidden",heatmapTooltip.style.left="0px",heatmapTooltip.getBoundingClientRect().width);let w=e.right+10;w+a>window.innerWidth&&(w=e.left-a-10),heatmapTooltip.style.left=w+"px",heatmapTooltip.style.top=e.top+"px",heatmapTooltip.style.display="block",heatmapTooltip.style.visibility="visible",a=heatmapTooltip.querySelector(".tooltip-close"),a&&a.addEventListener("click",hideTooltip),document.addEventListener("click",function c(v){v.target.classList.contains("tile")||heatmapTooltip.contains(v.target)||v.target===t||(hideTooltip(),document.removeEventListener("click",c))})}}function createCalendar(e,t){if(!e)return;e.innerHTML=`
    <div class="outer-box">
      <div class="year-select"></div>
      <div class="inner-box">
        <div class="calendar-container">
          ${["Mon","Wed","Fri"].map(n=>`<span class="week">${n}</span>`).join("")}
          <div class="legend">Less${new Array(5).fill(0).map((n,l)=>`<i class="tile" data-level="${l}"></i>`).join("")}More</div>
          <div class="tiles"></div>
        </div>
      </div>
    </div>
  `;let a=e.querySelector(".calendar-container"),r=e.querySelector(".year-select"),s=e.querySelector(".tiles"),o=completeContributionData(t),i=new Date().getFullYear(),m=(r.innerHTML=Object.keys(o).sort((n,l)=>l-n).map(n=>`<div class="year-option ${n==i?"active":""}">${n}</div>`).join(""),r.addEventListener("click",({target:n})=>{n.classList.contains("year-option")&&(e.querySelector(".active")?.classList.remove("active"),n.classList.add("active"),m(n.textContent))}),n=>{s.innerHTML="",a.querySelectorAll(".month").forEach(y=>y.remove()),a.querySelectorAll(".total").forEach(y=>y.remove());let l=o[n],d=new Date(l[0].date).getDay(),p=-1,E=document.createDocumentFragment(),w=document.createDocumentFragment(),c=-1;var[v,L]=l.reduce(([y,h],g,u)=>{var $=new Date(g.date),M=$.getMonth();if(h.count+=g.count,h.post+=g.post,$.getDay()===0&&M!==p){let D=2+Math.floor((u+d)/7),f=(D-c<=1&&(D+=2-D+c),c=D,p=M,document.createElement("span"));f.className="month",f.textContent=MONTH_NAMES[M],f.style.gridColumn=D,E.append(f)}return u=document.createElement("i"),u.className="tile",u.dataset.level=g.level,u.title=getTooltip(g,$),u.dataset.level=g.level,u.dataset.date=g.date,u.addEventListener("click",tileClickHandler),y.push(u),[y,h]},[[],{count:0,post:0}]);v[0]&&(v[0].style.gridRow=d+1),w.append(...v),a.append(E),s.append(w),a.insertAdjacentHTML("beforeend",`<div class="total">${pluralize(L.post,"post")} ${pluralize(L.count,"word")} in ${n}</div>`)});m(i)}function completeContributionData(e){e.sort((o,i)=>o.date-i.date);let t=new Date(e[0].date),a=new Date,r={},s={};e.forEach(o=>{var i=new Date(o.date),i=`${i.getFullYear()}-${i.getMonth()}-`+i.getDate();s[i]=o});for(let o=t.getFullYear();o<=a.getFullYear();o++){let[i,m]=o===a.getFullYear()?[new Date(new Date(a).setDate(a.getDate()-365)),new Date(a.getTime()+864e5)]:[new Date(o,0,1),new Date(o+1,0,1)],n=[];for(let l=i;l<m;l.setDate(l.getDate()+1)){let d=`${l.getFullYear()}-${l.getMonth()}-`+l.getDate();n.push(s[d]||{level:0,date:l.getTime(),count:0,post:0})}r[o]=n}return r}function getLevelFromWordCount(e){var t=window.REIMU_HEATMAP_CONFIG.levelStandard.split(",").map(Number);return e<=0?0:e<=t[0]?1:e<=t[1]?2:e<=t[2]?3:4}var currentDate=new Date;function transformArticlesData(e){return e=e.reduce((t,{date:a,wordcount:r})=>{var s;return new Date(a)>currentDate?t:(s=t.get(a)??{count:0,post:0},t.set(a,{count:s.count+r,post:s.post+1}))},new Map),Array.from(e,([t,{count:a,post:r}])=>({level:getLevelFromWordCount(a),date:new Date(t).getTime(),count:a,post:r}))}createCalendar(document.querySelector("#heatmap"),transformArticlesData(window.REIMU_HEATMAP_CONFIG.articleStats));
